<!DOCTYPE html>
<html lang="pt-BR">
  <head>
  <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>Picture Cube -- Beta</title>
  
    <link rel="stylesheet" href="css/style.css">

    <script src="marked.min.js"></script>
    <script src="bluetooth.js"></script>

    <script src="cube-core.js"></script>

    <script src="cube-view.js"></script>
    <script src="renderers/cubenet-renderer.js"></script>
    <script src="renderers/perspective-renderer.js"></script>
    <script src="renderers/isometric-renderer.js"></script>

    <script src="scramble.js"></script>
  </head>

  <body>

    <button id="hamburger" onclick="toggleSidebar()" title="Toggle sidebar">â˜°</button>
    <button id="togglePanel" onclick="toggleLeftPanel()" title="Toggle panel">â˜°</button>
    <button id="fullscreenBtn" onclick="toggleFullscreen()" title="Fullscreen">â›¶</button>
    <div id="container">
      <div id="controls">
        <div class="spacer"></div>
        <button class="texture-editor-btn" onclick="toggleEditor()">
          ðŸŽ¨ Textures Editor (experimental)
        </button>
        <div class="accordion open">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            Moveset
            <svg class="accordion-arrow" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </button>
          <div class="accordion-content">
            <div class="move-grid">
              <!-- Face Moves -->
              <button onclick="applyMove('U')">U</button>
              <button onclick="applyMove('U\'')">U'</button>
              <button onclick="applyMove('U2')">U2</button>
              <button onclick="applyMove('D')">D</button>
              <button onclick="applyMove('D\'')">D'</button>
              <button onclick="applyMove('D2')">D2</button>
              <button onclick="applyMove('R')">R</button>
              <button onclick="applyMove('R\'')">R'</button>
              <button onclick="applyMove('R2')">R2</button>
              <button onclick="applyMove('L')">L</button>
              <button onclick="applyMove('L\'')">L'</button>
              <button onclick="applyMove('L2')">L2</button>
              <button onclick="applyMove('F')">F</button>
              <button onclick="applyMove('F\'')">F'</button>
              <button onclick="applyMove('F2')">F2</button>
              <button onclick="applyMove('B')">B</button>
              <button onclick="applyMove('B\'')">B'</button>
              <button onclick="applyMove('B2')">B2</button>
              <!-- Slice Moves -->
              <button onclick="applyMove('M')">M</button>
              <button onclick="applyMove('M\'')">M'</button>
              <button onclick="applyMove('M2')">M2</button>
              <button onclick="applyMove('E')">E</button>
              <button onclick="applyMove('E\'')">E'</button>
              <button onclick="applyMove('E2')">E2</button>
              <button onclick="applyMove('S')">S</button>
              <button onclick="applyMove('S\'')">S'</button>
              <button onclick="applyMove('S2')">S2</button>
              <!-- Rotations -->
              <button onclick="applyMove('x')">X</button>
              <button onclick="applyMove('x\'')">X'</button>
              <button onclick="applyMove('x2')">X2</button>
              <button onclick="applyMove('y')">Y</button>
              <button onclick="applyMove('y\'')">Y'</button>
              <button onclick="applyMove('y2')">Y2</button>
              <button onclick="applyMove('z')">Z</button>
              <button onclick="applyMove('z\'')">Z'</button>
              <button onclick="applyMove('z2')">Z2</button>
              <!-- Wide Moves -->
              <button onclick="applyMove('Rw')">Rw</button>
              <button onclick="applyMove('Rw\'')">Rw'</button>
              <button onclick="applyMove('Rw2')">Rw2</button>
              <button onclick="applyMove('Lw')">Lw</button>
              <button onclick="applyMove('Lw\'')">Lw'</button>
              <button onclick="applyMove('Lw2')">Lw2</button>
              <button onclick="applyMove('Uw')">Uw</button>
              <button onclick="applyMove('Uw\'')">Uw'</button>
              <button onclick="applyMove('Uw2')">Uw2</button>
              <button onclick="applyMove('Dw')">Dw</button>
              <button onclick="applyMove('Dw\'')">Dw'</button>
              <button onclick="applyMove('Dw2')">Dw2</button>
              <button onclick="applyMove('Fw')">Fw</button>
              <button onclick="applyMove('Fw\'')">Fw'</button>
              <button onclick="applyMove('Fw2')">Fw2</button>
              <button onclick="applyMove('Bw')">Bw</button>
              <button onclick="applyMove('Bw\'')">Bw'</button>
              <button onclick="applyMove('Bw2')">Bw2</button>
            </div>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            Algorithm
            <svg class="accordion-arrow" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </button>
          <div class="accordion-content">
            <textarea
              id="alg"
              placeholder="Enter algorithm (ex: R U R&#39; U&#39;)"
              onkeydown="if(event.ctrlKey && event.key==='Enter') applyAlgorithm()"
            ></textarea>
            <button onclick="applyAlgorithm()">Execute</button>
            <button onclick="scrambleCube()">Scramble Cube</button>
            <small style="color: #666; font-style: italic"
              >Tip: Press Ctrl+Enter to execute</small
            >
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            Bluetooth Cube
            <svg class="accordion-arrow" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </button>
          <div class="accordion-content">
            <button id="bluetoothBtn" onclick="toggleBluetooth()">Connect GiiKER Cube</button>
            <div id="bluetoothStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            Camera Control
            <svg class="accordion-arrow" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </button>
          <div class="accordion-content">
            <button id="cameraBtn" onclick="toggleCamera()">Enable Camera</button>
            <div id="cameraContainer" style="position: relative; display: none;">
              <video id="cameraPreview" autoplay muted style="width: 100%; max-width: 280px; border: 2px solid #555; border-radius: 8px;"></video>
              <div id="headDot" style="position: absolute; width: 10px; height: 10px; background: red; border-radius: 50%; display: none;"></div>
            </div>
            <div id="cameraControls" style="display: none; margin-top: 10px;">
              <select id="cameraSelect" style="width: 100%; margin: 5px 0; padding: 5px;">
                <option value="">Select Camera...</option>
              </select>
              <button onclick="calibrateCamera()">Calibrate</button>
              <div style="margin: 10px 0;">
                <label><input type="checkbox" id="sameSensitivity"> Same Value</label>
                <label><input type="checkbox" id="invertX"> Invert X</label>
                <label><input type="checkbox" id="invertY"> Invert Y</label>
              </div>
              <div style="margin: 10px 0;">
                <label>Sensitivity X: <span id="sensitivityXValue">60</span></label>
                <input type="range" id="sensitivityX" min="10" max="120" value="60" style="width: 100%;">
              </div>
              <div style="margin: 10px 0;">
                <label>Sensitivity Y: <span id="sensitivityYValue">40</span></label>
                <input type="range" id="sensitivityY" min="10" max="120" value="40" style="width: 100%;">
              </div>
              <div style="margin: 10px 0;">
                <label>Offset X: <span id="offsetXValue">0</span></label>
                <input type="range" id="offsetX" min="-160" max="160" value="0" style="width: 100%;">
              </div>
              <div style="margin: 10px 0;">
                <label>Offset Y: <span id="offsetYValue">0</span></label>
                <input type="range" id="offsetY" min="-120" max="120" value="0" style="width: 100%;">
              </div>
              <div style="margin: 10px 0;">
                <label><input type="checkbox" id="sameBgSensitivity"> Same Value BG</label>
                <label><input type="checkbox" id="invertBgX"> Invert BG X</label>
                <label><input type="checkbox" id="invertBgY"> Invert BG Y</label>
              </div>
              <div style="margin: 10px 0;">
                <label>BG Sensitivity X: <span id="bgSensitivityXValue">30</span></label>
                <input type="range" id="bgSensitivityX" min="0" max="100" value="30" style="width: 100%;">
              </div>
              <div style="margin: 10px 0;">
                <label>BG Sensitivity Y: <span id="bgSensitivityYValue">30</span></label>
                <input type="range" id="bgSensitivityY" min="0" max="100" value="30" style="width: 100%;">
              </div>
            </div>
            <div id="cameraStatus" style="margin-top: 10px; font-size: 12px; color: #666;">Camera disabled</div>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            State
            <svg class="accordion-arrow" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </button>
          <div class="accordion-content">
            <button onclick="solveCube()">Reset</button>
            <button onclick="openStateModal()">View State</button>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            History
            <svg class="accordion-arrow" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </button>
          <div class="accordion-content">
            <div class="history-controls">
              <button onclick="clearHistory()">Clear</button>
            </div>
            <div class="history-graph" id="historyGraph"></div>
            <div class="history-grid">
              <div class="history-header">
                <div class="history-cell">Time</div>
                <div class="history-cell">Move</div>
                <div class="history-cell">#</div>
              </div>
              <div id="historyRows"></div>
            </div>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            Example Textures
            <svg class="accordion-arrow" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </button>
          <div class="accordion-content">
            <select id="exampleSelect" onchange="loadExample()">
              <option value="">Select an example...</option>
              <?php
              $examplesDir = 'examples/';
              $examples = [];
              if (is_dir($examplesDir)) {
                $files = scandir($examplesDir);
                foreach ($files as $file) {
                  if (pathinfo($file, PATHINFO_EXTENSION) === 'json') {
                    $name = pathinfo($file, PATHINFO_FILENAME);
                    $json = file_get_contents($examplesDir . $file);
                    $json = stripJsonComments($json);
                    $content = json_decode($json, true);
                    $examples[$file] = $content;
                    $selected = ($file === '05-pochman_supercube.json') ? ' selected' : '';
                    echo "<option value='$file'$selected>$name</option>";
                  }
                }
              }
              ?>
            </select>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            Custom Textures
            <svg class="accordion-arrow" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </button>
          <div class="accordion-content">
            <a
              href="#"
              onclick="openInstructionsModal()"
              style="font-size: 14px; margin-bottom: 10px; display: inline-block"
              >[Instructions]</a
            >
            <textarea
              id="customConfig"
              placeholder='{"textures": {"red": "#c41e3a", "star": {"background": "url(\"star.svg\")", "backgroundSize": "80%"}}, "cube": {"U": "red", "U1": ["red", "star"]}}'
            ></textarea>
            <button onclick="loadCustomConfig()">Apply Textures</button>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            Background
            <svg class="accordion-arrow" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </button>
          <div class="accordion-content" style="margin: 0;">
            <div id="backgroundGallery" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; max-height: 50vh; overflow-y: auto; overflow-x: hidden; margin: 0;">
              <div class='bg-thumb none' data-bg='' onclick='selectBackground("")'></div>
              <?php
              $backgroundsDir = 'backgrounds/';
              if (is_dir($backgroundsDir)) {
                $files = scandir($backgroundsDir);
                foreach ($files as $file) {
                  if ($file !== '.' && $file !== '..' && preg_match('/\.(png|jpg|jpeg|gif|webp|svg)$/i', $file)) {
                    echo "<div class='bg-thumb' data-bg='$file' onclick='selectBackground(\"$file\")' style='background-image:url(\"backgrounds/$file\");'></div>";
                  }
                }
              }
              ?>
            </div>
          </div>
        </div>

        <div class="accordion">
          <button class="accordion-header" onclick="toggleAccordion(this)">
            Visualization
            <svg class="accordion-arrow" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/>
            </svg>
          </button>
          <div class="accordion-content">
            <button id="cubenetBtn" onclick="setViewMode('cubenet')" disabled>
              Cube Net
            </button>
            <button id="orthographicBtn" onclick="setViewMode('orthographic')">
              3D Orthographic
            </button>
            <button id="perspectiveBtn" onclick="setViewMode('perspective')">
              3D Perspective
            </button><br /><br />
            <button id="crispBtn" onclick="window.toggleCrispMode()">
              Crisp Mode: OFF
            </button><br /><br />
            <button id="throttleBtn" onclick="toggleRenderThrottle()">
              Render Throttle: OFF
            </button>
            <em style="display: block; margin-top: 5px; font-size: 11px; color: #666;">
              Limits rendering to 60 FPS for smoother performance during fast solves (bluetooth cube)
            </em>
          </div>
        </div>
      </div>

      <div id="right-panel">
        <iframe id="editor-iframe" src="editor/"></iframe>
        <div class="loading-spinner" id="loadingSpinner"></div>
        <div id="cube-net">
          <div class="face-2d face-U" data-face="U"></div>
          <div class="face-2d face-L" data-face="L"></div>
          <div class="face-2d face-F" data-face="F"></div>
          <div class="face-2d face-R" data-face="R"></div>
          <div class="face-2d face-B" data-face="B"></div>
          <div class="face-2d face-D" data-face="D"></div>
        </div>

        <div id="cube-3d-wrapper">
          <div id="cube-3d">
            <div class="face-3d face-U" data-face="U"></div>
            <div class="face-3d face-D" data-face="D"></div>
            <div class="face-3d face-F" data-face="F"></div>
            <div class="face-3d face-B" data-face="B"></div>
            <div class="face-3d face-L" data-face="L"></div>
            <div class="face-3d face-R" data-face="R"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Instructions Modal -->
    <div id="instructionsModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeInstructionsModal()">&times;</span>
        <div id="instructionsContent">Loading...</div>
        <script>
          <?php
          if (file_exists('texture-instructions.md')) {
            $markdown = file_get_contents('texture-instructions.md');
            echo 'const markdownContent = ' . json_encode($markdown) . ';';
            echo 'document.getElementById("instructionsContent").innerHTML = marked.parse(markdownContent);';
          } else {
            echo 'document.getElementById("instructionsContent").innerHTML = "<p>Instructions file not found.</p>";';
          }
          ?>
        </script>
      </div>
    </div>

    <!-- State Modal -->
    <div id="stateModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeStateModal()">&times;</span>
        <h3>Cube Analysis</h3>
        <div class="tab-container">
          <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('state')">State</button>
            <button class="tab-button" onclick="switchTab('rotations')">Rotations</button>
          </div>
          <div id="stateTab" class="tab-content active"></div>
          <div id="rotationsTab" class="tab-content"></div>
        </div>
      </div>
    </div>

    <div id="toast" class="toast"></div>


<script>
  const defaultTexture = <?php 
        function stripJsonComments($json) {
          $result = '';
          $inString = false;
          $inComment = false;
          $inBlockComment = false;
          $len = strlen($json);
          for ($i = 0; $i < $len; $i++) {
            $char = $json[$i];
            $next = ($i + 1 < $len) ? $json[$i + 1] : '';
            if ($inBlockComment) {
              if ($char === '*' && $next === '/') {
                $inBlockComment = false;
                $i++;
              }
              continue;
            }
            if ($inComment) {
              if ($char === "\n") {
                $inComment = false;
                $result .= $char;
              }
              continue;
            }
            if ($char === '"' && ($i === 0 || $json[$i - 1] !== '\\')) {
              $inString = !$inString;
              $result .= $char;
              continue;
            }
            if (!$inString) {
              if ($char === '/' && $next === '/') {
                $inComment = true;
                $i++;
                continue;
              }
              if ($char === '/' && $next === '*') {
                $inBlockComment = true;
                $i++;
                continue;
              }
            }
            $result .= $char;
          }
          return $result;
        }
        $json = file_get_contents('examples/05-pochman_supercube.json');
        $json = stripJsonComments($json);
        echo json_encode(json_decode($json, true)); 
      ?>;



  const examples = <?php echo json_encode($examples); ?>;
const examplesRaw = <?php 
  $rawExamples = [];
  foreach ($examples as $file => $content) {
    $rawExamples[$file] = file_get_contents($examplesDir . $file);
  }
  echo json_encode($rawExamples);
?>;
</script>
    <script src="js/app.js"></script>
  </body>
</html>
